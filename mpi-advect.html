<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MPI Linear Advection Equation &mdash; PHY 504 Spring 2024 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
      <link rel="stylesheet" type="text/css" href="_static/theme_overrides.css?v=851f9797" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=60df5cae"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="_static/copybutton.js?v=f281be69"></script>
        <script src="_static/design-tabs.js?v=36754332"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "macros": {"kth": "{{k_\\mathrm{th}}}", "gcc": "{\\mathrm{g~cm^{-3}}}", "cms": "{\\mathrm{cm~s^{-1}}}", "presunit": "{\\mathrm{dyn~cm^{-2}}}", "accelunit": "{\\mathrm{cm~s^{-2}}}", "ergg": "{\\mathrm{erg~g^{-1}}}", "Ab": "{{\\bf A}}", "eb": "{{\\bf e}}", "Fb": "{{\\bf F}}", "gb": "{{\\bf g}}", "Hb": "{{\\bf H}}", "ib": "{{\\bf i}}", "Ib": "{{\\bf I}}", "Kb": "{{\\bf K}}", "lb": "{{\\bf l}}", "Lb": "{{\\bf L}}", "nb": "{{\\bf n}}", "Pb": "{{\\bf P}}", "Qb": "{{\\bf Q}}", "rb": "{{\\bf r}}", "Rb": "{{\\bf R}}", "Sb": "{{\\bf S}}", "ub": "{{\\bf u}}", "Ub": "{{\\bf U}}", "xb": "{{\\bf x}}", "dt": "{\\Delta t}", "omegadot": "{\\dot\\omega}", "inp": "{{\\rm in}}", "outp": "{{\\rm out}}", "sync": "{{\\rm sync}}", "half": "{\\frac{1}{2}}", "myhalf": "{\\half}", "nph": "{{n+\\myhalf}}", "kpp": "{\\ensuremath{\\kappa_{\\mathrm{P}}}}", "kpr": "{\\ensuremath{\\kappa_{\\mathrm{R}}}}", "kpf": "{\\ensuremath{\\kappa_{\\mathrm{F}}}}", "vb": "{\\boldsymbol{v}}", "vbt": "{\\widetilde{\\vb}}", "rbt": "{\\widetilde{\\rb}}", "ob": "{\\boldsymbol{\\omega}}", "nablab": "{\\boldsymbol{\\nabla}}", "avg": ["{{\\left \\langle #1 \\right \\rangle}}", 1]}}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="pybind11" href="cxx-python.html" />
    <link rel="prev" title="MPI Send and Receive" href="mpi-sendrecv.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            PHY 504
          </a>
              <div class="version">
                Spring 2024
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Intro &amp; Logistics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="topics.html">Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="computing.html">Computation</a></li>
<li class="toctree-l1"><a class="reference internal" href="hello_world.html">Hello, World</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">The UNIX Shell</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="why_command_line.html">Why Use the Command Line?</a></li>
<li class="toctree-l1"><a class="reference internal" href="shell.html">Navigating the Filesystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="shell-2.html">Create Files and Directories</a></li>
<li class="toctree-l1"><a class="reference internal" href="shell-3.html">Redirection and Pipes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Git and Version Control</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="version_control.html">Version Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="shell-setup.html">Dotfiles and the Mathlab</a></li>
<li class="toctree-l1"><a class="reference internal" href="git.html">A Git Walkthrough</a></li>
<li class="toctree-l1"><a class="reference internal" href="git-branches.html">Git Branches</a></li>
<li class="toctree-l1"><a class="reference internal" href="git-remotes.html">Git Remotes</a></li>
<li class="toctree-l1"><a class="reference internal" href="github.html">github</a></li>
<li class="toctree-l1"><a class="reference internal" href="pull-requests.html">Pull Requests</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Shell Scripting</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="shell-looping.html">Looping on the Command Line</a></li>
<li class="toctree-l1"><a class="reference internal" href="shell-scripts.html">Shell Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="permissions.html">File Permissions</a></li>
<li class="toctree-l1"><a class="reference internal" href="finding.html">Find and Grep</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Introduction to Programming</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="book.html">C++ Textbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="hardware.html">Computer Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="development-tools.html">Software Development Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="structure.html">Structure of a C++ Program</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Helpful C++ Tools / Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="compiling.html">Compiling</a></li>
<li class="toctree-l1"><a class="reference internal" href="editors.html">Editors</a></li>
<li class="toctree-l1"><a class="reference internal" href="first_project.html">A First C++ Project</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">C++ Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cxx-datatypes.html">C++ Datatypes</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-vectors.html">Vectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-more-vectors.html">More Vectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-matrix-example.html">Example: Matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-sequence-containers.html">Aside: Sequence Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-strings.html">Strings</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-auto-decltype.html"><code class="docutils literal notranslate"><span class="pre">auto</span></code> and <code class="docutils literal notranslate"><span class="pre">decltype</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-structs.html">Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-arrays.html">Arrays</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-pointers.html">Pointers</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-statements.html">Loops and If-Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-maps.html">Maps</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-io.html">File I/O</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Functions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cxx-functions.html">Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-functions-example.html">More Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-orbit-example.html">Example: Planetary Orbit</a></li>
<li class="toctree-l1"><a class="reference internal" href="inclass-rk2-orbit.html">In Class: 2nd Order Runge-Kutta Orbit</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-lambdas.html">Lambda Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-functions-planets.html">Example: Sorting Planets</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Elements of Software Engineering</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="compiler-flags.html">Making the Compiler Do the Work</a></li>
<li class="toctree-l1"><a class="reference internal" href="multiple-files.html">Working with Multiple Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="make.html">Makefiles</a></li>
<li class="toctree-l1"><a class="reference internal" href="inclass-split-orbit.html">In-Class Example: Splitting Up Our Orbit Code</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cxx-classes-intro.html">Introduction to Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="object-oriented.html">Object-Oriented Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="inclass-class-example.html">In-Class Example: A Simple Grid</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-vector2d-class.html">Example: Mathematical Vectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="inclass-orbit-class.html">In-Class Example: Orbit Integrator Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="contiguous_array.html">Example: Multidimensional Contiguous Array</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Some Random Bits...</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cxx-mdspan.html">Preview: C++23 mdspan</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-enumerate-zip.html">Preview: C++23 enumerate and zip</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-enum.html">enum</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-casting.html">Casting</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-iomanip.html">I/O Manipulators</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-print.html">Preview: C++23 Print</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-filesystem.html">Filesystem Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="operators.html">Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="floating-point.html">Floating Point</a></li>
<li class="toctree-l1"><a class="reference internal" href="floating-point-exceptions.html">Floating Point Exceptions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Testing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-unit-tests.html">Unit Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="github-ci.html">Continuous integration and github</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-convergence-tests.html">Convergence Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="valgrind.html">Valgrind</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="clang-tidy.html">clang-tidy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Digging Deeper into C++ Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="inheritance-and-access.html">Inheritance and Access</a></li>
<li class="toctree-l1"><a class="reference internal" href="this-class.html"><code class="docutils literal notranslate"><span class="pre">this</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="copy_and_assignment.html">Copy, Assignment, and Destructors</a></li>
<li class="toctree-l1"><a class="reference internal" href="compound-operators.html">Compound Assignment Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="inclass-orbit-compound.html">In-Class Example: Orbit Integrator Compound Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-move.html">Move Semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-allocating.html">Allocating Memory</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-simple-container.html">Example: A Simple Container</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Documenting Code</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="html-css.html">HTML + CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="github-pages.html">Github Pages</a></li>
<li class="toctree-l1"><a class="reference internal" href="doxygen.html">Doxygen</a></li>
<li class="toctree-l1"><a class="reference internal" href="sphinx.html">Sphinx</a></li>
<li class="toctree-l1"><a class="reference internal" href="sphinx-doxygen.html">Sphinx + Doxygen</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Templates</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="templates-intro.html">Templates</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-template-array.html">Example: Templated Array</a></li>
<li class="toctree-l1"><a class="reference internal" href="templates-more.html">More On Templates</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-constexpr.html"><code class="docutils literal notranslate"><span class="pre">constexpr</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="functionals.html">Function Objects</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Some Numerical Algorithms</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="roots.html">Root Finding</a></li>
<li class="toctree-l1"><a class="reference internal" href="monte-carlo.html">Monte Carlo Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="adaptive_rk4.html">Adaptive Runge-Kutta</a></li>
<li class="toctree-l1"><a class="reference internal" href="poisson-relax.html">Poisson Equation and Relaxation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Parallel Programming</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="parallel-intro.html">Introduction to Parallel Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="openmp-intro.html">OpenMP</a></li>
<li class="toctree-l1"><a class="reference internal" href="openmp-relax.html">OpenMP Poisson Relaxation</a></li>
<li class="toctree-l1"><a class="reference internal" href="openmp-pi.html">OpenMP Monte Carlo <span class="math notranslate nohighlight">\(\pi\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="mpi-intro.html">MPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="mpi-sendrecv.html">MPI Send and Receive</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">MPI Linear Advection Equation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#domain-decomposition">Domain decomposition</a></li>
<li class="toctree-l2"><a class="reference internal" href="#array"><code class="docutils literal notranslate"><span class="pre">Array</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#grid"><code class="docutils literal notranslate"><span class="pre">Grid</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#main-program-driver">Main program driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ghost-cell-filling">Ghost cell filling</a></li>
<li class="toctree-l2"><a class="reference internal" href="#outputting">Outputting</a></li>
<li class="toctree-l2"><a class="reference internal" href="#initialization-and-parameters">Initialization and parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running">Running</a></li>
<li class="toctree-l2"><a class="reference internal" href="#scaling">Scaling</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Calling C++ from Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cxx-python.html">pybind11</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-python-sum.html">Passing a NumPy Array into C++</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-python-array.html">Returning an Array to Python</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">To Be Continued...</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="didnt_cover.html">Stuff We Didn’t Cover</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx20.html">Coming in C++20</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx23.html">Coming in C++23</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-glossary.html">Some C++ programming terms</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Homework</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="homework/homework1.html">Homework 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="homework/homework2.html">Homework 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="homework/homework3.html">Homework 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="homework/homework4.html">Homework 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="homework/homework5.html">Homework 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="homework/homework6.html">Homework 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="homework/homework7.html">Homework 7</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Project</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="project.html">Final Project</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">PHY 504</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">MPI Linear Advection Equation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/mpi-advect.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="mpi-linear-advection-equation">
<h1>MPI Linear Advection Equation<a class="headerlink" href="#mpi-linear-advection-equation" title="Link to this heading"></a></h1>
<p>Let’s look at a very crude way to solve the linear advection equation in two-dimensions:</p>
<p><div class="math notranslate nohighlight">
\[a_t + u a_x + v a_y = 0\]</div>
</p>
<p>We will do a very simple, first-order accurate discretization:</p>
<div class="math notranslate nohighlight">
\[\frac{a^{n+1}_{i,j} - a^n_{i,j}}{\Delta t} =
        - u \frac{a^n_{i,j} - a^n_{i-1,j}}{\Delta x}
        - v \frac{a^n_{i,j} - a^n_{i,j-1}}{\Delta y}\]</div>
<p>This discretization assumes that <span class="math notranslate nohighlight">\(u &gt; 0\)</span> and <span class="math notranslate nohighlight">\(v &gt; 0\)</span>.  In that case, it is <em>upwinded</em>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is only stable for <span class="math notranslate nohighlight">\(\mathcal{C} &lt; 1/2\)</span>, where</p>
<div class="math notranslate nohighlight">
\[\mathcal{C} = \max \left \{ \frac{u \Delta t}{\Delta x}, \frac{v \Delta t}{\Delta y} \right \}\]</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This is a very bad discretization of advection.  Our concern here
is not on the accuracy of the method, but to demonstrate how to do
the domain decomposition.  For better methods for advection, see
<a class="reference external" href="https://zingale.github.io/computational_astrophysics/advection/advection-intro.html">my lecture notes on advection</a>.</p>
</div>
<p>The solution to the linear advection equation is to take what ever the initial
<span class="math notranslate nohighlight">\(a(x, y)\)</span> is and move it with a speed <span class="math notranslate nohighlight">\((u, v)\)</span> with the shape unchanged.</p>
<p>We’ll use periodic boundary conditions and advect for a period, after which
the solution should be identical to the initial conditions.  Any differences
are due to numerical (truncation) error in our discretization.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can get all the code for this example here:
<a class="reference external" href="https://github.com/zingale/phy504/tree/main/examples/parallel/mpi/advect">https://github.com/zingale/phy504/tree/main/examples/parallel/mpi/advect</a></p>
</div>
<section id="domain-decomposition">
<h2>Domain decomposition<a class="headerlink" href="#domain-decomposition" title="Link to this heading"></a></h2>
<p>We will divide our domain along the x-direction:</p>
<a class="reference internal image-reference" href="_images/domain-oned.png"><img alt="_images/domain-oned.png" class="align-center" src="_images/domain-oned.png" style="width: 80%;" /></a>
<p>Each MPI process will manage their own subdomain.  To make things
easier, we will refer to a global index space on the entire domain.</p>
<p>For the figure above, the indices of the grids, (<code class="docutils literal notranslate"><span class="pre">ilo</span></code>, <code class="docutils literal notranslate"><span class="pre">ihi</span></code>, <code class="docutils literal notranslate"><span class="pre">jlo</span></code>, <code class="docutils literal notranslate"><span class="pre">jhi</span></code>) are:</p>
<ul class="simple">
<li><p>left grid: (<code class="docutils literal notranslate"><span class="pre">0</span></code>, <code class="docutils literal notranslate"><span class="pre">4</span></code>, <code class="docutils literal notranslate"><span class="pre">0</span></code>, <code class="docutils literal notranslate"><span class="pre">9</span></code>)</p></li>
<li><p>middle grid: (<code class="docutils literal notranslate"><span class="pre">5</span></code>, <code class="docutils literal notranslate"><span class="pre">9</span></code>, <code class="docutils literal notranslate"><span class="pre">0</span></code>, <code class="docutils literal notranslate"><span class="pre">9</span></code>)</p></li>
<li><p>right grid: (<code class="docutils literal notranslate"><span class="pre">10</span></code>, <code class="docutils literal notranslate"><span class="pre">14</span></code>, <code class="docutils literal notranslate"><span class="pre">0</span></code>, <code class="docutils literal notranslate"><span class="pre">9</span></code>)</p></li>
</ul>
<p>Each of these grids will be managed by a separate MPI task.  To deal
with the boundaries of each grid, we will have a perimeter of ghost
cells, shown as the red outline for the middle grid.  We will use MPI
send/recv to exchange data with the neighboring grids to fill these
ghost cells.</p>
<p>For the physical boundaries, we will assume we are periodic.</p>
</section>
<section id="array">
<h2><code class="docutils literal notranslate"><span class="pre">Array</span></code><a class="headerlink" href="#array" title="Link to this heading"></a></h2>
<p>We want a version of our <code class="docutils literal notranslate"><span class="pre">Array</span></code> class that can
start at an arbitrary index, e.g., for the middle grid above (excluding ghost cells):</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">Array</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">)</span>
</pre></div>
</div>
<p>This is easy to do by adapting our existing <code class="docutils literal notranslate"><span class="pre">Array</span></code> class to include an offset:</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-number">Listing 136 </span><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">array.H</span></code></span><a class="headerlink" href="#id1" title="Link to this code"></a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef ARRAY_H</span>
<span class="cp">#define ARRAY_H</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cassert&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stacktrace&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;limits&gt;</span>

<span class="c1">///</span>
<span class="c1">/// a contiguous 2-d array -- here the data is stored in row-major</span>
<span class="c1">/// order in a 1-d memory space managed as a vector.  The array index</span>
<span class="c1">/// does not need to start at 0 here, instead a constructor is</span>
<span class="c1">/// provided that takes the starting index and ending index in each</span>
<span class="c1">/// dimension</span>
<span class="c1">///</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Array</span><span class="w"> </span><span class="p">{</span>

<span class="k">public</span><span class="o">:</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nx</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ny</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">_xoffset</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">_yoffset</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">_data</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>

<span class="w">    </span><span class="n">Array</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">xlo</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">xhi</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ylo</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">yhi</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">nx</span><span class="p">{</span><span class="n">xhi</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">xlo</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">},</span><span class="w"> </span><span class="n">ny</span><span class="p">{</span><span class="n">yhi</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ylo</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">},</span><span class="w"> </span><span class="n">_xoffset</span><span class="p">{</span><span class="n">xlo</span><span class="p">},</span><span class="w"> </span><span class="n">_yoffset</span><span class="p">{</span><span class="n">ylo</span><span class="p">},</span>
<span class="w">          </span><span class="n">_data</span><span class="p">(</span><span class="n">nx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ny</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">assert</span><span class="w"> </span><span class="p">(</span><span class="n">nx</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">assert</span><span class="w"> </span><span class="p">(</span><span class="n">ny</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">xlo</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">_xoffset</span><span class="p">;}</span>
<span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ylo</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">_yoffset</span><span class="p">;}</span>

<span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">xhi</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">_xoffset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;}</span>
<span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">yhi</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">_yoffset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ny</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;}</span>

<span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="kt">double</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="p">()(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">_xoffset</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">_yoffset</span><span class="p">;</span>
<span class="w">        </span><span class="n">assert</span><span class="w"> </span><span class="p">(</span><span class="n">row</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nx</span><span class="p">);</span>
<span class="w">        </span><span class="n">assert</span><span class="w"> </span><span class="p">(</span><span class="n">col</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ny</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">_data</span><span class="p">[</span><span class="n">row</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ny</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="p">()(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">_xoffset</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">_yoffset</span><span class="p">;</span>
<span class="w">        </span><span class="n">assert</span><span class="w"> </span><span class="p">(</span><span class="n">row</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nx</span><span class="p">);</span>
<span class="w">        </span><span class="n">assert</span><span class="w"> </span><span class="p">(</span><span class="n">col</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ny</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">_data</span><span class="p">[</span><span class="n">row</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ny</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">_data</span><span class="p">.</span><span class="n">data</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">_data</span><span class="p">.</span><span class="n">data</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>

<span class="p">};</span>
<span class="cp">#endif</span>
</pre></div>
</div>
</div>
</section>
<section id="grid">
<h2><code class="docutils literal notranslate"><span class="pre">Grid</span></code><a class="headerlink" href="#grid" title="Link to this heading"></a></h2>
<p>We will manage each processor’s subdomain with a <code class="docutils literal notranslate"><span class="pre">grid</span></code> class.  This class
takes the domain size and number of points as well as each MPI processes rank
and the total number of MPI processes and computes the domain decomposition
for each rank.</p>
<p>It also has a method to generate an array allocated for that rank, including
ghost cells.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-number">Listing 137 </span><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">grid.H</span></code></span><a class="headerlink" href="#id2" title="Link to this code"></a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef GRID_H</span>
<span class="cp">#define GRID_H</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cassert&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cmath&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;format&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;array.H&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Grid</span><span class="w"> </span><span class="p">{</span>

<span class="k">public</span><span class="o">:</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">dx</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">dy</span><span class="p">;</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ng</span><span class="p">;</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ilo</span><span class="p">{</span><span class="mi">-1</span><span class="p">};</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ihi</span><span class="p">{</span><span class="mi">-1</span><span class="p">};</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">jlo</span><span class="p">{</span><span class="mi">-1</span><span class="p">};</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">jhi</span><span class="p">{</span><span class="mi">-1</span><span class="p">};</span>

<span class="w">    </span><span class="n">Grid</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">_nx</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">_ny</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">_ng</span><span class="p">,</span>
<span class="w">         </span><span class="kt">double</span><span class="w"> </span><span class="n">_xmin</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">_xmax</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">_ymin</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">_ymax</span><span class="p">,</span>
<span class="w">         </span><span class="kt">int</span><span class="w"> </span><span class="n">_rank</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">_nprocs</span><span class="p">)</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">ng</span><span class="p">(</span><span class="n">_ng</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">assert</span><span class="w"> </span><span class="p">(</span><span class="n">_xmax</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">_xmin</span><span class="p">);</span>
<span class="w">        </span><span class="n">assert</span><span class="w"> </span><span class="p">(</span><span class="n">_ymax</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">_ymin</span><span class="p">);</span>
<span class="w">        </span><span class="n">assert</span><span class="w"> </span><span class="p">(</span><span class="n">_nx</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">assert</span><span class="w"> </span><span class="p">(</span><span class="n">_ny</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">        </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_xmax</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">_xmin</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_nx</span><span class="p">);</span>
<span class="w">        </span><span class="n">dy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_ymax</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">_ymin</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_ny</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// each processor will hold a slab with the i coordinates</span>
<span class="w">        </span><span class="c1">// spanning ~ 1/_nx of the x-domain, and the j coordinates</span>
<span class="w">        </span><span class="c1">// spanning the entire j range.  We will refer to a</span>
<span class="w">        </span><span class="c1">// global index space of _nx x _ny.</span>

<span class="w">        </span><span class="c1">// note: with this decomposition, the data will be</span>
<span class="w">        </span><span class="c1">// contiguous in memory on each processor</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">iwidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">floor</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_nx</span><span class="p">)</span><span class="w"> </span><span class="o">/</span>
<span class="w">                                </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_nprocs</span><span class="p">));</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">iextra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_nx</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">_nprocs</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// the first iwidth processors have a width of iwidth+1</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">mywidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iwidth</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_rank</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">iextra</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">mywidth</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// current processor&#39;s index space</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_rank</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">iextra</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">ilo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">iwidth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_rank</span><span class="p">;</span>
<span class="w">            </span><span class="n">ihi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ilo</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mywidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">ilo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">iwidth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">iextra</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">iwidth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">_rank</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">iextra</span><span class="p">);</span>
<span class="w">            </span><span class="n">ihi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ilo</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mywidth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">jlo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">jhi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ny</span><span class="mi">-1</span><span class="p">;</span>

<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">///</span>
<span class="w">    </span><span class="c1">/// get a scratch array indexed on this rank&#39;s subdomain</span>
<span class="w">    </span><span class="c1">/// with a perimeter of ghost cells</span>
<span class="w">    </span><span class="c1">///</span>
<span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="n">Array</span><span class="w"> </span><span class="n">scratch_array</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Array</span><span class="w"> </span><span class="nf">arr</span><span class="p">(</span><span class="n">ilo</span><span class="o">-</span><span class="n">ng</span><span class="p">,</span><span class="w"> </span><span class="n">ihi</span><span class="o">+</span><span class="n">ng</span><span class="p">,</span><span class="w"> </span><span class="n">jlo</span><span class="o">-</span><span class="n">ng</span><span class="p">,</span><span class="w"> </span><span class="n">jhi</span><span class="o">+</span><span class="n">ng</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">arr</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">};</span>


<span class="kr">inline</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">os</span><span class="p">,</span><span class="w"> </span><span class="n">Grid</span><span class="w"> </span><span class="n">g</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">os</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;i: ({:3}, {:3}); j: ({:3}, {:3})&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="n">g</span><span class="p">.</span><span class="n">ilo</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">ihi</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">jlo</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">jhi</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">os</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>
</pre></div>
</div>
</div>
</section>
<section id="main-program-driver">
<h2>Main program driver<a class="headerlink" href="#main-program-driver" title="Link to this heading"></a></h2>
<p>The main program driver is pretty simple:</p>
<ul class="simple">
<li><p>Create the grid on each MPI process</p></li>
<li><p>Set the initial conditions</p></li>
<li><p>Loop until we reach the final time</p>
<ul>
<li><p>Compute the timestep</p></li>
<li><p>Fill the ghost cells</p></li>
<li><p>Update <span class="math notranslate nohighlight">\(a\)</span> to the new time solution</p></li>
</ul>
</li>
<li><p>Output the solution</p></li>
</ul>
<p>Here’s the code:</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-number">Listing 138 </span><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">advection.cpp</span></code></span><a class="headerlink" href="#id3" title="Link to this code"></a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;print&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mpi.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;grid.H&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;simulation.H&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;initialize.H&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;output.H&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ghost_fill.H&quot;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">     </span><span class="n">MPI_Init</span><span class="p">(</span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>

<span class="w">     </span><span class="kt">int</span><span class="w"> </span><span class="n">rank</span><span class="p">{</span><span class="mi">-1</span><span class="p">};</span>
<span class="w">     </span><span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rank</span><span class="p">);</span>

<span class="w">     </span><span class="kt">int</span><span class="w"> </span><span class="n">nprocs</span><span class="p">{</span><span class="mi">-1</span><span class="p">};</span>
<span class="w">     </span><span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nprocs</span><span class="p">);</span>

<span class="w">     </span><span class="kt">double</span><span class="w"> </span><span class="n">start_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPI_Wtime</span><span class="p">();</span>

<span class="w">     </span><span class="c1">// setup the grid</span>

<span class="w">     </span><span class="n">Grid</span><span class="w"> </span><span class="n">g</span><span class="p">(</span><span class="n">domain</span><span class="o">::</span><span class="n">nx</span><span class="p">,</span><span class="w"> </span><span class="n">domain</span><span class="o">::</span><span class="n">ny</span><span class="p">,</span><span class="w"> </span><span class="n">domain</span><span class="o">::</span><span class="n">ng</span><span class="p">,</span>
<span class="w">            </span><span class="n">domain</span><span class="o">::</span><span class="n">xmin</span><span class="p">,</span><span class="w"> </span><span class="n">domain</span><span class="o">::</span><span class="n">xmax</span><span class="p">,</span><span class="w"> </span><span class="n">domain</span><span class="o">::</span><span class="n">ymin</span><span class="p">,</span><span class="w"> </span><span class="n">domain</span><span class="o">::</span><span class="n">ymax</span><span class="p">,</span>
<span class="w">            </span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">nprocs</span><span class="p">);</span>

<span class="w">     </span><span class="c1">// create the memory for storing the old and new solution</span>

<span class="w">     </span><span class="k">auto</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">scratch_array</span><span class="p">();</span>
<span class="w">     </span><span class="k">auto</span><span class="w"> </span><span class="n">anew</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">scratch_array</span><span class="p">();</span>

<span class="w">     </span><span class="c1">// initialize</span>
<span class="w">     </span><span class="n">initialize</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">);</span>

<span class="w">     </span><span class="c1">// output</span>
<span class="w">     </span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">{</span><span class="mf">0.0</span><span class="p">};</span>
<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">simulation</span><span class="o">::</span><span class="n">do_output</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="n">output</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">);</span>
<span class="w">     </span><span class="p">}</span>

<span class="w">     </span><span class="c1">// evolve</span>

<span class="w">     </span><span class="kt">int</span><span class="w"> </span><span class="n">nstep</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>

<span class="w">     </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">simulation</span><span class="o">::</span><span class="n">tmax</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">         </span><span class="c1">// get dt</span>

<span class="w">         </span><span class="kt">double</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simulation</span><span class="o">::</span><span class="n">C</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">dx</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">simulation</span><span class="o">::</span><span class="n">u</span><span class="p">,</span>
<span class="w">                                              </span><span class="n">g</span><span class="p">.</span><span class="n">dy</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">simulation</span><span class="o">::</span><span class="n">v</span><span class="p">);</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">simulation</span><span class="o">::</span><span class="n">tmax</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">             </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simulation</span><span class="o">::</span><span class="n">tmax</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>

<span class="w">         </span><span class="c1">// fill ghost cells</span>
<span class="w">         </span><span class="n">fill_ghost_cells</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">);</span>

<span class="w">         </span><span class="c1">// do the first-order unsplit update</span>

<span class="w">         </span><span class="c1">// note: this is unstable for C &gt; 0.5 because the update</span>
<span class="w">         </span><span class="c1">// does not see the diagonal upwind cell</span>

<span class="w">         </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">ilo</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">ihi</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">             </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">jlo</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">jhi</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                 </span><span class="n">anew</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span>
<span class="w">                     </span><span class="o">-</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">simulation</span><span class="o">::</span><span class="n">u</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">dx</span>
<span class="w">                     </span><span class="o">-</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">simulation</span><span class="o">::</span><span class="n">v</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="mi">-1</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">dy</span><span class="p">;</span>
<span class="w">             </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span>

<span class="w">         </span><span class="n">t</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">dt</span><span class="p">;</span>
<span class="w">         </span><span class="n">nstep</span><span class="o">++</span><span class="p">;</span>

<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">             </span><span class="n">std</span><span class="o">::</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;n = {:4d}; t = {:6.4f}; dt = {:8.4g}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nstep</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">dt</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>

<span class="w">         </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anew</span><span class="p">;</span>
<span class="w">     </span><span class="p">}</span>

<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">simulation</span><span class="o">::</span><span class="n">do_output</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="n">output</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">);</span>
<span class="w">     </span><span class="p">}</span>

<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;elapsed time: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">MPI_Wtime</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">     </span><span class="p">}</span>

<span class="w">     </span><span class="n">MPI_Finalize</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>There are two places where MPI communication comes into play—the
ghost cell filling and the outputting.</p>
</section>
<section id="ghost-cell-filling">
<h2>Ghost cell filling<a class="headerlink" href="#ghost-cell-filling" title="Link to this heading"></a></h2>
<p>For the ghost cell filling, each processor has a subdomain in an
array, <code class="docutils literal notranslate"><span class="pre">a</span></code>.  We need to fill <code class="docutils literal notranslate"><span class="pre">a(ilo-1,</span> <span class="pre">:)</span></code> by receiving data from the left, and in exchange, we need to pass <code class="docutils literal notranslate"><span class="pre">a(ilo,</span> <span class="pre">:)</span></code> to the left to fill the left process’s <code class="docutils literal notranslate"><span class="pre">a(ihi+1,</span> <span class="pre">:)</span></code>.</p>
<p>Our domain decomposition is done such that we are contiguous in the <code class="docutils literal notranslate"><span class="pre">j</span></code> index, that means
that we can specify the start of the column of data corresponding to <code class="docutils literal notranslate"><span class="pre">ilo-1</span></code> as <code class="docutils literal notranslate"><span class="pre">a(ilo-1,</span> <span class="pre">jlo-ng)</span></code>
and then using the MPI call to send the entire column of elements.</p>
<p>There are two <code class="docutils literal notranslate"><span class="pre">MPI_Sendrecv</span></code> calls, one for the left and the other for the right.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-number">Listing 139 </span><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">ghost_fill.H</span></code></span><a class="headerlink" href="#id4" title="Link to this code"></a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef GHOST_FILL_H</span>
<span class="cp">#define GHOST_FILL_H</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mpi.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;array.H&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;grid.H&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;simulation.H&quot;</span>

<span class="c1">///</span>
<span class="c1">/// fill ghostcells, assuming doubly periodic</span>
<span class="c1">///</span>
<span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">fill_ghost_cells</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Grid</span><span class="o">&amp;</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">Array</span><span class="o">&amp;</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// we are doing a 1-d domain decomposition in the x-direction</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">rank</span><span class="p">{</span><span class="mi">-1</span><span class="p">};</span>
<span class="w">    </span><span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rank</span><span class="p">);</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nprocs</span><span class="p">{</span><span class="mi">-1</span><span class="p">};</span>
<span class="w">    </span><span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nprocs</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// first do the periodic fill in the y-direction -- this is all</span>
<span class="w">    </span><span class="c1">// local</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">ilo</span><span class="o">-</span><span class="n">g</span><span class="p">.</span><span class="n">ng</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">ihi</span><span class="o">+</span><span class="n">g</span><span class="p">.</span><span class="n">ng</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">jlo</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">jhi</span><span class="p">);</span>
<span class="w">        </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">jhi</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">jlo</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// now fill the interior ghost cells</span>

<span class="w">    </span><span class="p">{</span>

<span class="w">        </span><span class="c1">// send the first column of valid data to the left to fill the</span>
<span class="w">        </span><span class="c1">// left PE&#39;s right ghost cells, and receive from the right PE.</span>
<span class="w">        </span><span class="c1">// Wrap periodically.</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">sendto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rank</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">nprocs</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">rank</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">recvfrom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rank</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nprocs</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">rank</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="n">MPI_Status</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<span class="w">        </span><span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">ilo</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">jlo</span><span class="o">-</span><span class="n">g</span><span class="p">.</span><span class="n">ng</span><span class="p">),</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">ny</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">sendto</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                     </span><span class="o">&amp;</span><span class="n">a</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">ihi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">jlo</span><span class="o">-</span><span class="n">g</span><span class="p">.</span><span class="n">ng</span><span class="p">),</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">ny</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">recvfrom</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                     </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="p">{</span>

<span class="w">        </span><span class="c1">// send the last column of valid data to the right to fill the</span>
<span class="w">        </span><span class="c1">// right PE&#39;s left ghost cells, and receive from the left PE.</span>
<span class="w">        </span><span class="c1">// Wrap periodically.</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">sendto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rank</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nprocs</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">rank</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">recvfrom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rank</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">nprocs</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">rank</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="n">MPI_Status</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<span class="w">        </span><span class="n">MPI_Sendrecv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">ihi</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">jlo</span><span class="o">-</span><span class="n">g</span><span class="p">.</span><span class="n">ng</span><span class="p">),</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">ny</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">sendto</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">                     </span><span class="o">&amp;</span><span class="n">a</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">ilo</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">jlo</span><span class="o">-</span><span class="n">g</span><span class="p">.</span><span class="n">ng</span><span class="p">),</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">ny</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">recvfrom</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">                     </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
<span class="cp">#endif</span>
</pre></div>
</div>
</div>
</section>
<section id="outputting">
<h2>Outputting<a class="headerlink" href="#outputting" title="Link to this heading"></a></h2>
<p>Only rank <code class="docutils literal notranslate"><span class="pre">0</span></code> will output, so we need to move the data from all the other
ranks to rank <code class="docutils literal notranslate"><span class="pre">0</span></code>.  This is called serial I/O.  We just output the data
one cell per line, with an empty line between rows.  This can be read into
<code class="docutils literal notranslate"><span class="pre">gnuplot</span></code> easily.</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-number">Listing 140 </span><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">output.H</span></code></span><a class="headerlink" href="#id5" title="Link to this code"></a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef OUTPUT_H</span>
<span class="cp">#define OUTPUT_H</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cmath&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fstream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;format&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mpi.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;array.H&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;grid.H&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;simulation.H&quot;</span>


<span class="c1">///</span>
<span class="c1">/// write out the data by copying everything to rank 0</span>
<span class="c1">///</span>
<span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">output</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Grid</span><span class="o">&amp;</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Array</span><span class="o">&amp;</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">rank</span><span class="p">{</span><span class="mi">-1</span><span class="p">};</span>
<span class="w">    </span><span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rank</span><span class="p">);</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nprocs</span><span class="p">{</span><span class="mi">-1</span><span class="p">};</span>
<span class="w">    </span><span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nprocs</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// rank 0 will do all of the writing</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">ofstream</span><span class="w"> </span><span class="n">ofile</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">tstr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;t{:5.3f}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">);</span>
<span class="w">        </span><span class="n">ofile</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;advection_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tstr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_mpi.out&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nprocs</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">            </span><span class="c1">// write out rank 0&#39;s data.  No communication needed</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">ilo</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">ihi</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">jlo</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">jhi</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">ofile</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="n">ofile</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>

<span class="w">            </span><span class="c1">// we are working on a rank &gt; 0, so we need to copy the</span>
<span class="w">            </span><span class="c1">// data over to rank 0</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">                </span><span class="c1">// transfer the index range</span>

<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">irange</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">g</span><span class="p">.</span><span class="n">ilo</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">ihi</span><span class="p">};</span>
<span class="w">                </span><span class="n">MPI_Send</span><span class="p">(</span><span class="n">irange</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_INT</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">);</span>

<span class="w">                </span><span class="c1">// now transfer the data -- we&#39;ll send everything,</span>
<span class="w">                </span><span class="c1">// including the ghost cells</span>

<span class="w">                </span><span class="n">MPI_Send</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">nx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">ny</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span>
<span class="w">                         </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">);</span>

<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">                </span><span class="c1">// receive the index range from rank n</span>

<span class="w">                </span><span class="n">MPI_Status</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>

<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">irange</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">};</span>
<span class="w">                </span><span class="n">MPI_Recv</span><span class="p">(</span><span class="n">irange</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_INT</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

<span class="w">                </span><span class="c1">// create a buffer to hold the data we will receive</span>

<span class="w">                </span><span class="n">Array</span><span class="w"> </span><span class="n">a_buf</span><span class="p">(</span><span class="n">irange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">g</span><span class="p">.</span><span class="n">ng</span><span class="p">,</span><span class="w"> </span><span class="n">irange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">g</span><span class="p">.</span><span class="n">ng</span><span class="p">,</span>
<span class="w">                            </span><span class="n">g</span><span class="p">.</span><span class="n">jlo</span><span class="o">-</span><span class="n">g</span><span class="p">.</span><span class="n">ng</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">jhi</span><span class="o">+</span><span class="n">g</span><span class="p">.</span><span class="n">ng</span><span class="p">);</span>

<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPI_Recv</span><span class="p">(</span><span class="n">a_buf</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">a_buf</span><span class="p">.</span><span class="n">nx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a_buf</span><span class="p">.</span><span class="n">ny</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span>
<span class="w">                                     </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ierr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MPI_SUCCESS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;error in recv: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">ierr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="c1">// output the buffer to the file</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">irange</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">irange</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">jlo</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">jhi</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">ofile</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">a_buf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                    </span><span class="n">ofile</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">            </span><span class="p">}</span>

<span class="w">        </span><span class="p">}</span>

<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
<span class="cp">#endif</span>
</pre></div>
</div>
</div>
</section>
<section id="initialization-and-parameters">
<h2>Initialization and parameters<a class="headerlink" href="#initialization-and-parameters" title="Link to this heading"></a></h2>
<p>We will do a simple smooth Gaussian as the initial conditions.</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-number">Listing 141 </span><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">initialize.H</span></code></span><a class="headerlink" href="#id6" title="Link to this code"></a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef INITIALIZE_H</span>
<span class="cp">#define INITIALIZE_H</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cmath&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mpi.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;array.H&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;grid.H&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;simulation.H&quot;</span>

<span class="c1">///</span>
<span class="c1">/// initialize the solution with a Gaussian</span>
<span class="c1">///</span>
<span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Grid</span><span class="o">&amp;</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">Array</span><span class="o">&amp;</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">xc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">domain</span><span class="o">::</span><span class="n">xmin</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">domain</span><span class="o">::</span><span class="n">xmax</span><span class="p">);</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">yc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">domain</span><span class="o">::</span><span class="n">ymin</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">domain</span><span class="o">::</span><span class="n">ymax</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">ilo</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">ihi</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">domain</span><span class="o">::</span><span class="n">xmin</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">dx</span><span class="p">;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">jlo</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">jhi</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">domain</span><span class="o">::</span><span class="n">ymin</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">dy</span><span class="p">;</span>

<span class="w">            </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">exp</span><span class="p">(</span><span class="mf">-60.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">pow</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">xc</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">                                              </span><span class="n">std</span><span class="o">::</span><span class="n">pow</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">yc</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#endif</span>
</pre></div>
</div>
</div>
<p>Finally, there is one additional header that holds the problem
parameters.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In a real simulation code, these would come via an inputs file that
is read at runtime.</p>
</div>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-number">Listing 142 </span><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">simulation.H</span></code></span><a class="headerlink" href="#id7" title="Link to this code"></a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef SIMULATION_H</span>
<span class="cp">#define SIMULATION_H</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">domain</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nx</span><span class="p">{</span><span class="mi">512</span><span class="p">};</span>
<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ny</span><span class="p">{</span><span class="mi">512</span><span class="p">};</span>
<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ng</span><span class="p">{</span><span class="mi">1</span><span class="p">};</span>

<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">xmin</span><span class="p">{</span><span class="mf">0.0</span><span class="p">};</span>
<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">xmax</span><span class="p">{</span><span class="mf">1.0</span><span class="p">};</span>
<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">ymin</span><span class="p">{</span><span class="mf">0.0</span><span class="p">};</span>
<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">ymax</span><span class="p">{</span><span class="mf">1.0</span><span class="p">};</span>
<span class="p">}</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">simulation</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">C</span><span class="p">{</span><span class="mf">0.4</span><span class="p">};</span>
<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">tmax</span><span class="p">{</span><span class="mf">1.0</span><span class="p">};</span>
<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">u</span><span class="p">{</span><span class="mf">1.0</span><span class="p">};</span>
<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">v</span><span class="p">{</span><span class="mf">1.0</span><span class="p">};</span>
<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">do_output</span><span class="p">{</span><span class="nb">true</span><span class="p">};</span>
<span class="p">}</span>

<span class="cp">#endif</span>
</pre></div>
</div>
</div>
</section>
<section id="running">
<h2>Running<a class="headerlink" href="#running" title="Link to this heading"></a></h2>
<p>Here’s a <code class="docutils literal notranslate"><span class="pre">GNUmakefile</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-number">Listing 143 </span><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">GNUmakefile</span></code></span><a class="headerlink" href="#id8" title="Link to this code"></a></div>
<div class="highlight-make notranslate"><div class="highlight"><pre><span></span><span class="nv">HEADERS</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">$(</span>wildcard<span class="w"> </span>*.H<span class="k">)</span>
<span class="nv">SOURCES</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">$(</span>wildcard<span class="w"> </span>*.cpp<span class="k">)</span>

<span class="nv">OBJECTS</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">$(</span>SOURCES:.cpp<span class="o">=</span>.o<span class="k">)</span>

<span class="nf">ALL</span><span class="o">:</span><span class="w"> </span><span class="n">advection</span>

<span class="nv">CXXFLAGS</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span>-Wall<span class="w"> </span>-Wextra<span class="w"> </span>-Wshadow<span class="w"> </span>-std<span class="o">=</span>c++23<span class="w"> </span>-g<span class="w"> </span>-O2

<span class="nf">%.o </span><span class="o">:</span><span class="w"> </span>%.<span class="n">cpp</span> ${<span class="n">HEADERS</span>}
<span class="w">	</span>mpic++<span class="w"> </span>-c<span class="w"> </span><span class="si">${</span><span class="nv">CXXFLAGS</span><span class="si">}</span><span class="w"> </span>$&lt;

<span class="nf">advection</span><span class="o">:</span><span class="w"> </span>${<span class="n">OBJECTS</span>} ${<span class="n">HEADERS</span>}
<span class="w">	</span>mpic++<span class="w"> </span>-o<span class="w"> </span><span class="nv">$@</span><span class="w"> </span><span class="si">${</span><span class="nv">OBJECTS</span><span class="si">}</span><span class="w"> </span>-lstdc++exp


<span class="nf">clean</span><span class="o">:</span>
<span class="w">	</span>rm<span class="w"> </span>-f<span class="w"> </span>*.o<span class="w"> </span>advection
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>I am using C++20 here, because I wanted to use <code class="docutils literal notranslate"><span class="pre">std::print()</span></code> and <code class="docutils literal notranslate"><span class="pre">std::format()</span></code>.</p>
</div>
<p>The code can be executed as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><style type="text/css">
span.prompt1:before {
  content: "$ ";
}
</style><span class="prompt1">mpiexec<span class="w"> </span>-n<span class="w"> </span><span class="m">4</span><span class="w"> </span>./advection</span>
</pre></div></div><p>To plot the output, we can do:</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-number">Listing 144 </span><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">plot.gp</span></code></span><a class="headerlink" href="#id9" title="Link to this code"></a></div>
<div class="highlight-gnuplot notranslate"><div class="highlight"><pre><span></span><span class="k">set</span><span class="w"> </span><span class="nb">term</span><span class="w"> </span><span class="n">x11</span><span class="w"> </span><span class="n">persist</span>
<span class="k">set</span><span class="w"> </span><span class="nb">view</span><span class="w"> </span><span class="n">map</span>
<span class="k">set</span><span class="w"> </span><span class="nb">size</span><span class="w"> </span><span class="n">ratio</span><span class="w"> </span><span class="mi">-1</span>
<span class="k">set</span><span class="w"> </span><span class="nb">autoscale</span><span class="w"> </span><span class="n">fix</span>
<span class="k">splot</span><span class="w"> </span><span class="s">&#39;advection_t1.000_mpi.out&#39;</span><span class="w"> </span><span class="nb">notitle</span><span class="w"> </span><span class="nb">w</span><span class="w"> </span><span class="n">pm3d</span>
</pre></div>
</div>
</div>
</section>
<section id="scaling">
<h2>Scaling<a class="headerlink" href="#scaling" title="Link to this heading"></a></h2>
<p>Our algorithm is very simple, so there is not much floating point work
/ zone.  As a result, it is easy for the communication to dominate
over the computation.  In a real simulation code, we’d do something
much more complicated to get a better solution, and this would not be
as much of an issue.</p>
<p>We also have one major serial part in our code—I/O.  Amdahl’s law says
that eventually this will dominate our runtime as we increase the number
of processors.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>In order to see good scaling, we need to run a reasonable large
problem size, like <span class="math notranslate nohighlight">\(512^2\)</span> and disable I/O (by changing
<code class="docutils literal notranslate"><span class="pre">simulation::do_output</span></code>)</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="mpi-sendrecv.html" class="btn btn-neutral float-left" title="MPI Send and Receive" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="cxx-python.html" class="btn btn-neutral float-right" title="pybind11" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022-2024, Michael Zingale.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  


</body>
</html>