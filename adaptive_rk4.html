<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Adaptive Runge-Kutta &mdash; PHY 504 Spring 2024 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
      <link rel="stylesheet" type="text/css" href="_static/theme_overrides.css?v=851f9797" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=60df5cae"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="_static/copybutton.js?v=f281be69"></script>
        <script src="_static/design-tabs.js?v=36754332"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "macros": {"kth": "{{k_\\mathrm{th}}}", "gcc": "{\\mathrm{g~cm^{-3}}}", "cms": "{\\mathrm{cm~s^{-1}}}", "presunit": "{\\mathrm{dyn~cm^{-2}}}", "accelunit": "{\\mathrm{cm~s^{-2}}}", "ergg": "{\\mathrm{erg~g^{-1}}}", "Ab": "{{\\bf A}}", "eb": "{{\\bf e}}", "Fb": "{{\\bf F}}", "gb": "{{\\bf g}}", "Hb": "{{\\bf H}}", "ib": "{{\\bf i}}", "Ib": "{{\\bf I}}", "Kb": "{{\\bf K}}", "lb": "{{\\bf l}}", "Lb": "{{\\bf L}}", "nb": "{{\\bf n}}", "Pb": "{{\\bf P}}", "Qb": "{{\\bf Q}}", "rb": "{{\\bf r}}", "Rb": "{{\\bf R}}", "Sb": "{{\\bf S}}", "ub": "{{\\bf u}}", "Ub": "{{\\bf U}}", "xb": "{{\\bf x}}", "dt": "{\\Delta t}", "omegadot": "{\\dot\\omega}", "inp": "{{\\rm in}}", "outp": "{{\\rm out}}", "sync": "{{\\rm sync}}", "half": "{\\frac{1}{2}}", "myhalf": "{\\half}", "nph": "{{n+\\myhalf}}", "kpp": "{\\ensuremath{\\kappa_{\\mathrm{P}}}}", "kpr": "{\\ensuremath{\\kappa_{\\mathrm{R}}}}", "kpf": "{\\ensuremath{\\kappa_{\\mathrm{F}}}}", "vb": "{\\boldsymbol{v}}", "vbt": "{\\widetilde{\\vb}}", "rbt": "{\\widetilde{\\rb}}", "ob": "{\\boldsymbol{\\omega}}", "nablab": "{\\boldsymbol{\\nabla}}", "avg": ["{{\\left \\langle #1 \\right \\rangle}}", 1]}}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Poisson Equation and Relaxation" href="poisson-relax.html" />
    <link rel="prev" title="Monte Carlo Methods" href="monte-carlo.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            PHY 504
          </a>
              <div class="version">
                Spring 2024
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Intro &amp; Logistics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="topics.html">Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="computing.html">Computation</a></li>
<li class="toctree-l1"><a class="reference internal" href="hello_world.html">Hello, World</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">The UNIX Shell</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="why_command_line.html">Why Use the Command Line?</a></li>
<li class="toctree-l1"><a class="reference internal" href="shell.html">Navigating the Filesystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="shell-2.html">Create Files and Directories</a></li>
<li class="toctree-l1"><a class="reference internal" href="shell-3.html">Redirection and Pipes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Git and Version Control</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="version_control.html">Version Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="shell-setup.html">Dotfiles and the Mathlab</a></li>
<li class="toctree-l1"><a class="reference internal" href="git.html">A Git Walkthrough</a></li>
<li class="toctree-l1"><a class="reference internal" href="git-branches.html">Git Branches</a></li>
<li class="toctree-l1"><a class="reference internal" href="git-remotes.html">Git Remotes</a></li>
<li class="toctree-l1"><a class="reference internal" href="github.html">github</a></li>
<li class="toctree-l1"><a class="reference internal" href="pull-requests.html">Pull Requests</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Shell Scripting</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="shell-looping.html">Looping on the Command Line</a></li>
<li class="toctree-l1"><a class="reference internal" href="shell-scripts.html">Shell Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="permissions.html">File Permissions</a></li>
<li class="toctree-l1"><a class="reference internal" href="finding.html">Find and Grep</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Introduction to Programming</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="book.html">C++ Textbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="hardware.html">Computer Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="development-tools.html">Software Development Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="structure.html">Structure of a C++ Program</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Helpful C++ Tools / Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="compiling.html">Compiling</a></li>
<li class="toctree-l1"><a class="reference internal" href="editors.html">Editors</a></li>
<li class="toctree-l1"><a class="reference internal" href="first_project.html">A First C++ Project</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">C++ Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cxx-datatypes.html">C++ Datatypes</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-vectors.html">Vectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-more-vectors.html">More Vectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-matrix-example.html">Example: Matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-sequence-containers.html">Aside: Sequence Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-strings.html">Strings</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-auto-decltype.html"><code class="docutils literal notranslate"><span class="pre">auto</span></code> and <code class="docutils literal notranslate"><span class="pre">decltype</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-structs.html">Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-arrays.html">Arrays</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-pointers.html">Pointers</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-statements.html">Loops and If-Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-maps.html">Maps</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-io.html">File I/O</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Functions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cxx-functions.html">Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-functions-example.html">More Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-orbit-example.html">Example: Planetary Orbit</a></li>
<li class="toctree-l1"><a class="reference internal" href="inclass-rk2-orbit.html">In Class: 2nd Order Runge-Kutta Orbit</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-lambdas.html">Lambda Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-functions-planets.html">Example: Sorting Planets</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Elements of Software Engineering</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="compiler-flags.html">Making the Compiler Do the Work</a></li>
<li class="toctree-l1"><a class="reference internal" href="multiple-files.html">Working with Multiple Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="make.html">Makefiles</a></li>
<li class="toctree-l1"><a class="reference internal" href="inclass-split-orbit.html">In-Class Example: Splitting Up Our Orbit Code</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cxx-classes-intro.html">Introduction to Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="object-oriented.html">Object-Oriented Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="inclass-class-example.html">In-Class Example: A Simple Grid</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-vector2d-class.html">Example: Mathematical Vectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="inclass-orbit-class.html">In-Class Example: Orbit Integrator Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="contiguous_array.html">Example: Multidimensional Contiguous Array</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Some Random Bits...</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cxx-mdspan.html">Preview: C++23 mdspan</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-enumerate-zip.html">Preview: C++23 enumerate and zip</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-enum.html">enum</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-casting.html">Casting</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-iomanip.html">I/O Manipulators</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-print.html">Preview: C++23 Print</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-filesystem.html">Filesystem Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="operators.html">Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="floating-point.html">Floating Point</a></li>
<li class="toctree-l1"><a class="reference internal" href="floating-point-exceptions.html">Floating Point Exceptions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Testing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-unit-tests.html">Unit Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="github-ci.html">Continuous integration and github</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-convergence-tests.html">Convergence Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="valgrind.html">Valgrind</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="clang-tidy.html">clang-tidy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Digging Deeper into C++ Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="inheritance-and-access.html">Inheritance and Access</a></li>
<li class="toctree-l1"><a class="reference internal" href="this-class.html"><code class="docutils literal notranslate"><span class="pre">this</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="copy_and_assignment.html">Copy, Assignment, and Destructors</a></li>
<li class="toctree-l1"><a class="reference internal" href="compound-operators.html">Compound Assignment Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="inclass-orbit-compound.html">In-Class Example: Orbit Integrator Compound Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-move.html">Move Semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-allocating.html">Allocating Memory</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-simple-container.html">Example: A Simple Container</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Documenting Code</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="html-css.html">HTML + CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="github-pages.html">Github Pages</a></li>
<li class="toctree-l1"><a class="reference internal" href="doxygen.html">Doxygen</a></li>
<li class="toctree-l1"><a class="reference internal" href="sphinx.html">Sphinx</a></li>
<li class="toctree-l1"><a class="reference internal" href="sphinx-doxygen.html">Sphinx + Doxygen</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Templates</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="templates-intro.html">Templates</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-template-array.html">Example: Templated Array</a></li>
<li class="toctree-l1"><a class="reference internal" href="templates-more.html">More On Templates</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-constexpr.html"><code class="docutils literal notranslate"><span class="pre">constexpr</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="functionals.html">Function Objects</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Some Numerical Algorithms</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="roots.html">Root Finding</a></li>
<li class="toctree-l1"><a class="reference internal" href="monte-carlo.html">Monte Carlo Methods</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Adaptive Runge-Kutta</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#th-order-rk">4th order RK</a></li>
<li class="toctree-l2"><a class="reference internal" href="#adaptive-timesteps">Adaptive timesteps</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implementation">Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-elliptical-orbits">Example: elliptical orbits</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-lorenz-system">Example: Lorenz system</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-using-a-lambda-function">Example: using a lambda-function</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="poisson-relax.html">Poisson Equation and Relaxation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Parallel Programming</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="parallel-intro.html">Introduction to Parallel Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="trivially-parallel.html">Trivially Parallel + BASH</a></li>
<li class="toctree-l1"><a class="reference internal" href="openmp-intro.html">OpenMP</a></li>
<li class="toctree-l1"><a class="reference internal" href="openmp-relax.html">OpenMP Poisson Relaxation</a></li>
<li class="toctree-l1"><a class="reference internal" href="openmp-pi.html">OpenMP Monte Carlo <span class="math notranslate nohighlight">\(\pi\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="mpi-intro.html">MPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="mpi-sendrecv.html">MPI Send and Receive</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">To Be Continued...</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="didnt_cover.html">Stuff We Didn’t Cover</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx20.html">Coming in C++20</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx23.html">Coming in C++23</a></li>
<li class="toctree-l1"><a class="reference internal" href="cxx-glossary.html">Some C++ programming terms</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Homework</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="homework/homework1.html">Homework 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="homework/homework2.html">Homework 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="homework/homework3.html">Homework 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="homework/homework4.html">Homework 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="homework/homework5.html">Homework 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="homework/homework6.html">Homework 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="homework/homework7.html">Homework 7</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Project</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="project.html">Final Project</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">PHY 504</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Adaptive Runge-Kutta</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/adaptive_rk4.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="adaptive-runge-kutta">
<h1>Adaptive Runge-Kutta<a class="headerlink" href="#adaptive-runge-kutta" title="Link to this heading"></a></h1>
<p>Previously we looked at the simple Euler and 2nd-order Runge-Kutta
methods for integration.  Now we will look at 4th order Runge-Kutta.
We will also:</p>
<ul>
<li><p>Write our integrator as a templated class that works with any
ODE system of the form:</p>
<div class="math notranslate nohighlight">
\[\frac{d{\bf y}}{dt} = {\bf f}(t, {\bf y})\]</div>
</li>
<li><p>Adapt the timestep taken internally to achieve a user-desired
error in the solution.</p></li>
</ul>
<section id="th-order-rk">
<h2>4th order RK<a class="headerlink" href="#th-order-rk" title="Link to this heading"></a></h2>
<p>Fourth-order Runge-Kutta consists of 4 stages and a final update, illustrated below:</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-0" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-0">
Stage 1</label><div class="sd-tab-content docutils">
<p>The advance begins by estimating the derivatives (righthand side or
slope) at time <span class="math notranslate nohighlight">\(t^n\)</span>.  We’ll call this <span class="math notranslate nohighlight">\({\bf k}_1\)</span>.</p>
<p><div class="math notranslate nohighlight">
\[{\bf k}_1 = {\bf f}(t^n, {\bf y}^n)\]</div>
</p>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/rk4_k1.png"><img alt="_images/rk4_k1.png" src="_images/rk4_k1.png" style="width: 90%;" /></a>
</figure>
</div>
<input id="sd-tab-item-1" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-1">
Stage 2</label><div class="sd-tab-content docutils">
<p>We then follow the slope <span class="math notranslate nohighlight">\({\bf k}_1\)</span> to the midpoint in time,
<span class="math notranslate nohighlight">\(t^{n+1/2}\)</span> and evaluate the slope there.  We call the new slope <span class="math notranslate nohighlight">\({\bf
k}_2\)</span>.</p>
<p><div class="math notranslate nohighlight">
\[{\bf k}_2 = {\bf f}(t^n + \tau/2, {\bf y}^n + (\tau/2) {\bf k}_1)\]</div>
</p>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/rk4_k2.png"><img alt="_images/rk4_k2.png" src="_images/rk4_k2.png" style="width: 90%;" /></a>
</figure>
</div>
<input id="sd-tab-item-2" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-2">
Stage 3</label><div class="sd-tab-content docutils">
<p>We then go back to the start, but this time follow the new slope,
<span class="math notranslate nohighlight">\({\bf k}_2\)</span> to the midpoint in time, <span class="math notranslate nohighlight">\(t^{n+1/2}\)</span>.  We again evaluate
the slope here, and call it <span class="math notranslate nohighlight">\({\bf k}_3\)</span>.</p>
<p><div class="math notranslate nohighlight">
\[{\bf k}_3 = {\bf f}(t^n + \tau/2, {\bf y}^n + (\tau/2) {\bf k}_2)\]</div>
</p>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/rk4_k3.png"><img alt="_images/rk4_k3.png" src="_images/rk4_k3.png" style="width: 90%;" /></a>
</figure>
</div>
<input id="sd-tab-item-3" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-3">
Stage 4</label><div class="sd-tab-content docutils">
<p>Finally, we go back to the start and follow <span class="math notranslate nohighlight">\({\bf k}_3\)</span> for the full
timestep, to <span class="math notranslate nohighlight">\(t^{n+1}\)</span> and evaluate the slope there, calling it <span class="math notranslate nohighlight">\({\bf
k}_4\)</span>.</p>
<p><div class="math notranslate nohighlight">
\[{\bf k}_4 = {\bf f}(t^n + \tau, {\bf y}^n + \tau {\bf k}_3)\]</div>
</p>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/rk4_k4.png"><img alt="_images/rk4_k4.png" src="_images/rk4_k4.png" style="width: 90%;" /></a>
</figure>
</div>
<input id="sd-tab-item-4" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-4">
Final update</label><div class="sd-tab-content docutils">
<p>We then get the updated solution using a linear combination of the 4
slopes:</p>
<p><div class="math notranslate nohighlight">
\[{\bf y}^{n+1} = {\bf y}^n + \frac{\tau}{6} ({\bf k}_1 + 2 {\bf k}_2 + 2 {\bf k}_3 + {\bf k}_4)\]</div>
</p>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/rk4_final.png"><img alt="_images/rk4_final.png" src="_images/rk4_final.png" style="width: 90%;" /></a>
</figure>
<p>Note the similarity of RK4 to Simpson’s rule for integration.</p>
</div>
</div>
</section>
<section id="adaptive-timesteps">
<h2>Adaptive timesteps<a class="headerlink" href="#adaptive-timesteps" title="Link to this heading"></a></h2>
<p>So far we’ve been integrating with a fixed timestep.  This gives us no real control over the error.  What we would like to do is take a small timestep when the solution is changing fast, and a larger timestep when the solution changes more slowly.</p>
<p>To do this, we need to be able to assess the error in our solution as
we integrate.  There are lots of different ways to do this in the
literature:</p>
<ul class="simple">
<li><p>Take two half steps and compare to one full step</p></li>
<li><p>Compare higher and lower order methods (sometimes the lower order
method is <em>embedded</em> in the higher-order method, for instance this
is the <a class="reference external" href="https://en.wikipedia.org/wiki/Dormand%E2%80%93Prince_method">RK45 method used by SciPy</a>).</p></li>
</ul>
<p>We’ll do the first method here, as it is the simplest.  Consider
integrating a function <span class="math notranslate nohighlight">\(y(t)\)</span> through some timestep <span class="math notranslate nohighlight">\(\tau\)</span>:</p>
<figure class="align-center" id="id1">
<a class="reference internal image-reference" href="_images/adaptive_timestep.png"><img alt="_images/adaptive_timestep.png" src="_images/adaptive_timestep.png" style="width: 90%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 14 </span><span class="caption-text">Adaptive timestep comparing <span class="math notranslate nohighlight">\(\tau/2\)</span> steps to a single <span class="math notranslate nohighlight">\(\tau\)</span> step.</span><a class="headerlink" href="#id1" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>The top evolution takes a single step of size <span class="math notranslate nohighlight">\(\tau\)</span> while the bottom
takes two steps each of <span class="math notranslate nohighlight">\(\tau/2\)</span>.  These two integrations both end at
<span class="math notranslate nohighlight">\(y(t+\tau)\)</span>, but we expect the one that took 2 half steps to be more
accurate (since the truncation error is smaller).</p>
<p>Now, we know that RK4 is <em>locally</em> 5th order accurate, so that means that
for our single step, the error will be:</p>
<p><div class="math notranslate nohighlight">
\[\epsilon \sim \tau^5\]</div>
</p>
<p>And imagine that we wanted to achieve an error of
<span class="math notranslate nohighlight">\(\epsilon_\mathrm{want}\)</span>—there is a timestep <span class="math notranslate nohighlight">\(\tau\)</span> that would
get this:</p>
<p><div class="math notranslate nohighlight">
\[\epsilon_\mathrm{want} \sim \tau_\mathrm{est}^5\]</div>
</p>
<p>If we take the ratio of these, then any proportionality cancels, and
we have</p>
<p><div class="math notranslate nohighlight">
\[\tau_\mathrm{est} = \tau \left (\frac{\epsilon_\mathrm{want}}{\epsilon} \right)^{1/5}\]</div>
</p>
<p>If we were not accurate enough, this would predict a finer timestep
that would give us our desired accuracy.  And if we were too accurate,
then this would tell us how much we could increase the timestep while
maintaining our desired accuracy.</p>
<p>Let’s consider doing this with RK4.  Our approach will be:</p>
<ol class="arabic">
<li><p>Integrate from <span class="math notranslate nohighlight">\(y(t)\)</span> to <span class="math notranslate nohighlight">\(y(t+\tau)\)</span> using a single timestep, <span class="math notranslate nohighlight">\(\tau\)</span>.</p>
<p>Call the solution <span class="math notranslate nohighlight">\(y^\mathrm{single}\)</span></p>
</li>
<li><p>Integrate from <span class="math notranslate nohighlight">\(y(t)\)</span> to <span class="math notranslate nohighlight">\(y(t+\tau)\)</span> using two steps of size <span class="math notranslate nohighlight">\(\tau/2\)</span>.</p>
<p>Call the solution <span class="math notranslate nohighlight">\(y^\mathrm{double}\)</span></p>
</li>
<li><p>Compute an estimate of the <em>relative error</em> in the solution as:</p>
<div class="math notranslate nohighlight">
\[\epsilon_\mathrm{rel} =
   \left | \frac{y^\mathrm{double} - y^\mathrm{single}}
                {y^\mathrm{double}} \right |\]</div>
</li>
<li><p>Compute the timestep that would give us our desired accuracy,
<span class="math notranslate nohighlight">\(\epsilon_\mathrm{want}\)</span>:</p>
<p><div class="math notranslate nohighlight">
\[\tau_\mathrm{est} = \tau \left (\frac{\epsilon_\mathrm{want}}{\epsilon_\mathrm{rel}} \right)^{1/5}\]</div>
</p>
</li>
<li><p>If <span class="math notranslate nohighlight">\(\epsilon_\mathrm{rel} &lt; \epsilon_\mathrm{want}\)</span> then our
timestep was good, and store the solution at time <span class="math notranslate nohighlight">\(t + \tau\)</span> as
<span class="math notranslate nohighlight">\(y^\mathrm{double}\)</span>.  Increase the timestep according to
<span class="math notranslate nohighlight">\(\tau_\mathrm{est}\)</span> for the next step.</p>
<p>If <span class="math notranslate nohighlight">\(\epsilon_\mathrm{rel} &gt; \epsilon_\mathrm{want}\)</span> then throw away
our solution and go back to <span class="math notranslate nohighlight">\(y(t)\)</span> and retry the integration with
the new, smaller <span class="math notranslate nohighlight">\(\tau_\mathrm{est}\)</span>.</p>
</li>
</ol>
<p>In practice, we usually limit the amount that the timestep can change
from one attempt to the next by a factor of <span class="math notranslate nohighlight">\(\sim 2\)</span> or so.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For a different method, the timestep estimate will likely be
different, since it depends on the scaling of the local truncation
error with the timestep, <span class="math notranslate nohighlight">\(\tau\)</span>.</p>
</div>
</section>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Link to this heading"></a></h2>
<p>Here’s the code:</p>
<p><a class="reference download internal" download="" href="_downloads/7067e04f21db1dc38bcfe25de90ca0d0/ode_integrator.H"><code class="xref download docutils literal notranslate"><span class="pre">ode_integrator.H</span></code></a></p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<code class="docutils literal notranslate"><span class="pre">ode_integrator.H</span></code><div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-number">Listing 117 </span><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">ode_integrator.H</span></code></span><a class="headerlink" href="#id2" title="Link to this code"></a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef ODE_INTEGRATOR_H</span>
<span class="cp">#define ODE_INTEGRATOR_H</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;array&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cassert&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cmath&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;functional&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iomanip&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;limits&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ranges&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>

<span class="c1">// A 4th-order Runge-Kutta integrator to solve:</span>
<span class="c1">//</span>
<span class="c1">//   dy/dt = f</span>
<span class="c1">//   y(t=0) = y0</span>
<span class="c1">//</span>
<span class="c1">// where y is a vector of length N.</span>
<span class="c1">// This is templated on the size of the system, N.</span>
<span class="c1">//</span>
<span class="c1">// The signature of the righthand side function, f, is:</span>
<span class="c1">//</span>
<span class="c1">// std::vector&lt;double&gt; f(double t, const std::array&lt;double&gt;&amp; y)</span>
<span class="c1">//</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">adaptive_rk4</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">S1</span><span class="p">{</span><span class="mf">0.9</span><span class="p">};</span>
<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">S2</span><span class="p">{</span><span class="mf">4.0</span><span class="p">};</span>
<span class="p">}</span>

<span class="k">using</span><span class="w"> </span><span class="n">rhs_func</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="kt">double</span><span class="p">,</span>
<span class="w">                                      </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&amp;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">using</span><span class="w"> </span><span class="n">rhs_param_func</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="kt">double</span><span class="p">,</span>
<span class="w">                                      </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&amp;</span><span class="p">,</span>
<span class="w">                                      </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&amp;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">solution</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">y</span><span class="p">{};</span>

<span class="w">    </span><span class="c1">// constructor that takes an vector of values</span>

<span class="w">    </span><span class="n">solution</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">t_in</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">y_in</span><span class="p">)</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">t</span><span class="p">(</span><span class="n">t_in</span><span class="p">),</span><span class="w"> </span><span class="n">y</span><span class="p">(</span><span class="n">y_in</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>

<span class="p">};</span>

<span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="w"> </span><span class="n">os</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">solution</span><span class="o">&amp;</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">os</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">setprecision</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="w">    </span><span class="n">os</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">setw</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">t</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">os</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">setw</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">os</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ODE</span><span class="w"> </span><span class="p">{</span>

<span class="k">public</span><span class="o">:</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">neqs</span><span class="p">{</span><span class="mi">-1</span><span class="p">};</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">n_rhs</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">n_reset</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">dt_min</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">()};</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">dt_max</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;::</span><span class="n">lowest</span><span class="p">()};</span>

<span class="k">private</span><span class="o">:</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">{</span><span class="mf">0.0</span><span class="p">};</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">y_init</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">params</span><span class="p">;</span>
<span class="w">    </span><span class="n">rhs_func</span><span class="w"> </span><span class="n">rhs</span><span class="p">;</span>
<span class="w">    </span><span class="n">rhs_param_func</span><span class="w"> </span><span class="n">rhs_param</span><span class="p">;</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">solution</span><span class="o">&gt;</span><span class="w"> </span><span class="n">history</span><span class="p">{};</span>

<span class="w">    </span><span class="c1">// do an update of the form y_new = y + dt * dydt</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">update_step</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">y0</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">dt</span><span class="p">,</span>
<span class="w">                                    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">dydt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">y_new</span><span class="p">{</span><span class="n">y0</span><span class="p">};</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0ul</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">y_new</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">y_new</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dydt</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">y_new</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// do a single step of RK4 given initial y0 and timestep dt</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">rk4_step</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">y0</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">dt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="c1">// get the k1 acceleration</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">k1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">rhs</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">y0</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">rhs_param</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">y0</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">);</span>
<span class="w">        </span><span class="n">n_rhs</span><span class="o">++</span><span class="p">;</span>

<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">k1</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">neqs</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// get the k2 acceleration</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">y_tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">update_step</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="n">k1</span><span class="p">);</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">rhs</span><span class="p">(</span><span class="n">t0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="n">y_tmp</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">rhs_param</span><span class="p">(</span><span class="n">t0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="n">y_tmp</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">);</span>
<span class="w">        </span><span class="n">n_rhs</span><span class="o">++</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// get the k3 acceleration</span>
<span class="w">        </span><span class="n">y_tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">update_step</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="n">k2</span><span class="p">);</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">k3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">rhs</span><span class="p">(</span><span class="n">t0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="n">y_tmp</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">rhs_param</span><span class="p">(</span><span class="n">t0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="n">y_tmp</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">);</span>
<span class="w">        </span><span class="n">n_rhs</span><span class="o">++</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// get the k4 acceleration</span>
<span class="w">        </span><span class="n">y_tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">update_step</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span><span class="w"> </span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="n">k3</span><span class="p">);</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">k4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">rhs</span><span class="p">(</span><span class="n">t0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="n">y_tmp</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">rhs_param</span><span class="p">(</span><span class="n">t0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="n">y_tmp</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">);</span>
<span class="w">        </span><span class="n">n_rhs</span><span class="o">++</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// compute the final update</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0ul</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">y0</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">y_tmp</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y0</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">dt</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">6.0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">k1</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">k2</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">k3</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k4</span><span class="p">[</span><span class="n">n</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">y_tmp</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>


<span class="k">public</span><span class="o">:</span>

<span class="w">    </span><span class="c1">// constructor that takes an vector with initial conditions</span>

<span class="w">    </span><span class="n">ODE</span><span class="p">(</span><span class="n">rhs_func</span><span class="w"> </span><span class="n">rhs_in</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">_y0</span><span class="p">)</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">neqs</span><span class="p">(</span><span class="n">_y0</span><span class="p">.</span><span class="n">size</span><span class="p">()),</span><span class="w"> </span><span class="n">y_init</span><span class="p">(</span><span class="n">_y0</span><span class="p">),</span><span class="w"> </span><span class="n">rhs</span><span class="p">(</span><span class="n">rhs_in</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">history</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">y_init</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// constructor that takes an vector with initial conditions</span>
<span class="w">    </span><span class="c1">// and another with params that are passed to the RHS function</span>

<span class="w">    </span><span class="n">ODE</span><span class="p">(</span><span class="n">rhs_param_func</span><span class="w"> </span><span class="n">rhs_in</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">_y0</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">_p</span><span class="p">)</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">neqs</span><span class="p">(</span><span class="n">_y0</span><span class="p">.</span><span class="n">size</span><span class="p">()),</span><span class="w"> </span><span class="n">y_init</span><span class="p">(</span><span class="n">_y0</span><span class="p">),</span><span class="w"> </span><span class="n">params</span><span class="p">(</span><span class="n">_p</span><span class="p">),</span><span class="w"> </span><span class="n">rhs_param</span><span class="p">(</span><span class="n">rhs_in</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">history</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">y_init</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// integrate the system to tmax.  Here, dt_in is the initial</span>
<span class="w">    </span><span class="c1">// timestep.  The timestep will be adjusted internally to get a</span>
<span class="w">    </span><span class="c1">// relative tolerace or rtol.</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">solution</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">integrate</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">dt_in</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">tmax</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">rtol</span><span class="o">=</span><span class="mf">1.</span><span class="n">e</span><span class="mi">-6</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="c1">// start with the suggested timestep</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">dt_new</span><span class="p">{</span><span class="n">dt_in</span><span class="p">};</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">dt</span><span class="p">{</span><span class="n">dt_in</span><span class="p">};</span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">tmax</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">sol_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">history</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// adaptive timestepping loop -- keep trying to take a</span>
<span class="w">            </span><span class="c1">// step until we achieve our desired error</span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">rel_error</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">()};</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">n_try</span><span class="p">{};</span>

<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">y_new</span><span class="p">{};</span>

<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">rel_error</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">rtol</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">                </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dt_new</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">tmax</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmax</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="c1">// take 2 half steps</span>

<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">y_tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rk4_step</span><span class="p">(</span><span class="n">sol_old</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="n">dt</span><span class="p">);</span>
<span class="w">                </span><span class="n">y_new</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rk4_step</span><span class="p">(</span><span class="n">y_tmp</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="n">dt</span><span class="p">);</span>

<span class="w">                </span><span class="c1">// now take a single step to cover dt</span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">y_single</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rk4_step</span><span class="p">(</span><span class="n">sol_old</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">dt</span><span class="p">);</span>

<span class="w">                </span><span class="c1">// y_new should be more accurate, so we&#39;ll keep that if</span>
<span class="w">                </span><span class="c1">// the error is low</span>

<span class="w">                </span><span class="n">rel_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0ul</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">y_new</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">rel_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">rel_error</span><span class="p">,</span>
<span class="w">                                         </span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">((</span><span class="n">y_new</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y_single</span><span class="p">[</span><span class="n">n</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">y_new</span><span class="p">[</span><span class="n">n</span><span class="p">]));</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="c1">// adaptive timestep algorithm</span>
<span class="w">                </span><span class="kt">double</span><span class="w"> </span><span class="n">dt_est</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">adaptive_rk4</span><span class="o">::</span><span class="n">S1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">pow</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">rtol</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">rel_error</span><span class="p">),</span><span class="w"> </span><span class="mf">0.2</span><span class="p">);</span>
<span class="w">                </span><span class="n">dt_new</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">clamp</span><span class="p">(</span><span class="n">dt_est</span><span class="p">,</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">adaptive_rk4</span><span class="o">::</span><span class="n">S2</span><span class="p">,</span><span class="w"> </span><span class="n">adaptive_rk4</span><span class="o">::</span><span class="n">S2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dt</span><span class="p">);</span>

<span class="w">                </span><span class="n">n_try</span><span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n_try</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// there were resets</span>
<span class="w">                </span><span class="n">n_reset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">n_try</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">dt_min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">dt_min</span><span class="p">,</span><span class="w"> </span><span class="n">dt</span><span class="p">);</span>
<span class="w">            </span><span class="n">dt_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">dt_max</span><span class="p">,</span><span class="w"> </span><span class="n">dt</span><span class="p">);</span>

<span class="w">            </span><span class="n">t</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">dt</span><span class="p">;</span>
<span class="w">            </span><span class="n">history</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">y_new</span><span class="p">);</span>

<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">history</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">};</span>

<span class="cp">#endif</span>
</pre></div>
</div>
</div>
</div>
</details><div class="admonition note">
<p class="admonition-title">Note</p>
<p>With C++23 we can write things a little cleaner using <code class="docutils literal notranslate"><span class="pre">std::views::zip()</span></code>,
for example, replacing:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">rel_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0ul</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">y_new</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">rel_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">rel_error</span><span class="p">,</span>
<span class="w">                          </span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">((</span><span class="n">y_new</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y_single</span><span class="p">[</span><span class="n">n</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">y_new</span><span class="p">[</span><span class="n">n</span><span class="p">]));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>with:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">rel_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="p">[</span><span class="n">yd</span><span class="p">,</span><span class="w"> </span><span class="n">ys</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">views</span><span class="o">::</span><span class="n">zip</span><span class="p">(</span><span class="n">y_new</span><span class="p">,</span><span class="w"> </span><span class="n">y_single</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">rel_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">rel_error</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">((</span><span class="n">yd</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ys</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">yd</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Some notes:</p>
<ul>
<li><p>We use <code class="docutils literal notranslate"><span class="pre">std::vector</span></code> internally to store the data for the system of ODEs.
We could have used <code class="docutils literal notranslate"><span class="pre">std::array</span></code>, but that would have required us to template
the <code class="docutils literal notranslate"><span class="pre">ODE</span></code> class on the number of equations.</p></li>
<li><p>At each point in time, the state of the system is stored in a <code class="docutils literal notranslate"><span class="pre">struct</span></code> called
<code class="docutils literal notranslate"><span class="pre">solution</span></code>.  There is a simple constructor that can fill the data.</p>
<p>We have an overload for the stream operation, <code class="docutils literal notranslate"><span class="pre">&lt;&lt;</span></code>, that works with a <code class="docutils literal notranslate"><span class="pre">solution</span></code> object.</p>
</li>
<li><p>Our righthand side function can have one of 2 signatures:</p>
<ul>
<li><p>A simple function of the form <span class="math notranslate nohighlight">\(f(t, y)\)</span>:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>A version that allows for a vector of parameters, <span class="math notranslate nohighlight">\(f(t, y, p)\)</span>:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">y</span><span class="p">,</span>
<span class="w">                      </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
<p>The second case allows us to pass a vector of parameters that the
system may depend on that are not the integration variables.  This
is a common feature in ODE integrators.</p>
</li>
<li><p>We use <a class="reference external" href="https://en.cppreference.com/w/cpp/container/vector/emplace_back">emplace_back</a>
instead of <code class="docutils literal notranslate"><span class="pre">push_back()</span></code> to add a <code class="docutils literal notranslate"><span class="pre">solution</span></code> to our history
vector.  This eliminates the need to create a temporary <code class="docutils literal notranslate"><span class="pre">solution</span></code>
object to push to the vector (likely through a move), e.g., as:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">history</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">solution</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">));</span>
</pre></div>
</div>
<p>instead <code class="docutils literal notranslate"><span class="pre">emplace_back</span></code> simply passes the arguments we give it to the constructor
and operates directly on the vector.</p>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">ODE</span></code> class manages the solution.  There are 2 constructors, one for each
type of righthand side function.  Each takes the set of initial conditions.</p></li>
</ul>
<p>The basic usage is:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">y0</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">2.0</span><span class="p">);</span>
<span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ODE</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">y0</span><span class="p">);</span>
<span class="k">auto</span><span class="w"> </span><span class="n">history</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="n">tmax</span><span class="p">);</span>
</pre></div>
</div>
<p>The integrator will take the number of equations in the system from
the number of initial conditions, and it will expect that the
righthand side function, <code class="docutils literal notranslate"><span class="pre">f</span></code> returns a vector of this length (this
is asserted).</p>
<p>We can also use an initialization list like:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ODE</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">2.0</span><span class="p">});</span>
</pre></div>
</div>
<p>Finally, the <code class="docutils literal notranslate"><span class="pre">integrate</span></code> member function can optionally take the relative
tolerance with which to find the solution.</p>
</section>
<section id="example-elliptical-orbits">
<h2>Example: elliptical orbits<a class="headerlink" href="#example-elliptical-orbits" title="Link to this heading"></a></h2>
<p>Here’s a driver for integrating orbits.  We pick a high eccentricity which means
that the planet’s speed will vary a lot over the orbit.</p>
<p>The initial conditions put the planet on the +x axis, at perihelion, with a
counterclockwise orbit.  They are:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align*}
  x &amp;= a (1 - e) \\
  y &amp;= 0 \\
  u &amp;= 0 \\
  v &amp;= \sqrt{\frac{GM}{a} \frac{1+e}{1-e}}
\end{align*}\end{split}\]</div>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-number">Listing 118 </span><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">test_orbit.cpp</span></code></span><a class="headerlink" href="#id3" title="Link to this code"></a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cmath&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ode_integrator.H&quot;</span>

<span class="k">enum</span><span class="w"> </span><span class="nc">orbit_comps</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ix</span><span class="p">,</span>
<span class="w">    </span><span class="n">iy</span><span class="p">,</span>
<span class="w">    </span><span class="n">iu</span><span class="p">,</span>
<span class="w">    </span><span class="n">iv</span><span class="p">};</span>

<span class="k">constexpr</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">GM</span><span class="p">{</span><span class="mf">4.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">M_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">M_PI</span><span class="p">};</span><span class="w">   </span><span class="c1">// G * Mass in AU, year, solar mass unit</span>

<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">orbit</span><span class="p">([[</span><span class="n">maybe_unused</span><span class="p">]]</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span>
<span class="w">                          </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// order is x, y, u, v</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">dxdt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">iu</span><span class="p">];</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">dydt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">iv</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// du/dt = - GMx/r**3; dv/dt = - GMy/r**3</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">iy</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">iy</span><span class="p">]);</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">dudt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">GM</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">pow</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">dvdt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">GM</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">iy</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">pow</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="n">dxdt</span><span class="p">,</span><span class="w"> </span><span class="n">dydt</span><span class="p">,</span><span class="w"> </span><span class="n">dudt</span><span class="p">,</span><span class="w"> </span><span class="n">dvdt</span><span class="p">};</span>

<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="p">{</span><span class="mf">1.0</span><span class="p">};</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">e</span><span class="p">{</span><span class="mf">0.8</span><span class="p">};</span>

<span class="w">    </span><span class="c1">// planet is at perihelion initially</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">r_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">v_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="n">GM</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">e</span><span class="p">));</span>

<span class="w">    </span><span class="n">ODE</span><span class="w"> </span><span class="nf">o</span><span class="p">(</span><span class="n">orbit</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">r_p</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">v_p</span><span class="p">});</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">tol</span><span class="p">{</span><span class="mf">1.</span><span class="n">e</span><span class="mi">-4</span><span class="p">};</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">trajectory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">integrate</span><span class="p">(</span><span class="mf">0.025</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="n">tol</span><span class="p">);</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;# number of RHS evaluations = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">n_rhs</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;# number of rejected steps = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">n_reset</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;# dt range = [&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">dt_min</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">dt_max</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;]&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">trajectory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Notice that in our RHS function, we don’t explicitly create the <code class="docutils literal notranslate"><span class="pre">std::vector</span></code>
that we will return, but instead our return looks like:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="n">dxdt</span><span class="p">,</span><span class="w"> </span><span class="n">dydt</span><span class="p">,</span><span class="w"> </span><span class="n">dudt</span><span class="p">,</span><span class="w"> </span><span class="n">dvdt</span><span class="p">};</span>
</pre></div>
</div>
<p>This is an example of using a braced initialization list for the return.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>When run, the output will show the range of timesteps taken.</p>
</div>
<p>Here’s a plot of the output, showing the points computed during the solution.  Notice that
at perihelion they are much more closely spaced than at aphelion.</p>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/orbit_adaptive.png"><img alt="_images/orbit_adaptive.png" src="_images/orbit_adaptive.png" style="width: 80%;" /></a>
</figure>
<div class="admonition-try-it admonition">
<p class="admonition-title">try it…</p>
<p>How does our solution compare (in terms of accuracy and number of steps) if we
force the code to use a uniform timestep?</p>
</div>
</section>
<section id="example-lorenz-system">
<h2>Example: Lorenz system<a class="headerlink" href="#example-lorenz-system" title="Link to this heading"></a></h2>
<p>Here’s a driver for integrating the <a class="reference external" href="https://en.wikipedia.org/wiki/Lorenz_system">Lorenz system</a>.
This system appears as:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align*}
  \frac{dx}{dt} &amp;= \sigma (y - x) \\
  \frac{dy}{dt} &amp;= x (\rho - z) - y \\
  \frac{dz}{dt} &amp;= xy - \beta z
\end{align*}\end{split}\]</div>
<p>and is a simple model for convection.  Here, <span class="math notranslate nohighlight">\(x\)</span> is a measure of the rate of convection,
<span class="math notranslate nohighlight">\(y\)</span> is related to the horizontal temperature variation, and <span class="math notranslate nohighlight">\(z\)</span> is related to the vertical
temperature structure.  There are 3 parameters: <span class="math notranslate nohighlight">\(\sigma\)</span> is the Prandtl number, <span class="math notranslate nohighlight">\(\rho\)</span>
is the Rayleigh number, and <span class="math notranslate nohighlight">\(\beta\)</span> is related to the system size.</p>
<p>Lorenz chose <span class="math notranslate nohighlight">\(\sigma = 10\)</span>, <span class="math notranslate nohighlight">\(\beta = 8/3\)</span>, and <span class="math notranslate nohighlight">\(\rho = 28\)</span>.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-number">Listing 119 </span><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">test_lorenz.cpp</span></code></span><a class="headerlink" href="#id4" title="Link to this code"></a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ode_integrator.H&quot;</span>

<span class="k">enum</span><span class="w"> </span><span class="nc">lorenz_comps</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ix</span><span class="p">,</span>
<span class="w">    </span><span class="n">iy</span><span class="p">,</span>
<span class="w">    </span><span class="n">iz</span><span class="p">};</span>

<span class="k">enum</span><span class="w"> </span><span class="nc">param_comps</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">isigma</span><span class="p">,</span>
<span class="w">    </span><span class="n">irho</span><span class="p">,</span>
<span class="w">    </span><span class="n">ibeta</span><span class="p">};</span>

<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">rhs</span><span class="p">([[</span><span class="n">maybe_unused</span><span class="p">]]</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span>
<span class="w">                        </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">y</span><span class="p">,</span>
<span class="w">                        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">params</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">dxdt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">params</span><span class="p">[</span><span class="n">isigma</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">iy</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">dydt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">params</span><span class="p">[</span><span class="n">irho</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">iy</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">iz</span><span class="p">];</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">dzdt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">iy</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">params</span><span class="p">[</span><span class="n">ibeta</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">iz</span><span class="p">];</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="n">dxdt</span><span class="p">,</span><span class="w"> </span><span class="n">dydt</span><span class="p">,</span><span class="w"> </span><span class="n">dzdt</span><span class="p">};</span>

<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// these are the parameters that Lorenz used</span>

<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">sigma</span><span class="p">{</span><span class="mf">10.0</span><span class="p">};</span>
<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">rho</span><span class="p">{</span><span class="mf">28.0</span><span class="p">};</span>
<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">beta</span><span class="p">{</span><span class="mf">8.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">};</span>

<span class="w">    </span><span class="n">ODE</span><span class="w"> </span><span class="nf">o</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="mf">-10.0</span><span class="p">,</span><span class="w"> </span><span class="mf">-10.0</span><span class="p">,</span><span class="w"> </span><span class="mf">-10.0</span><span class="p">},</span>
<span class="w">          </span><span class="p">{</span><span class="n">sigma</span><span class="p">,</span><span class="w"> </span><span class="n">rho</span><span class="p">,</span><span class="w"> </span><span class="n">beta</span><span class="p">});</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">tol</span><span class="p">{</span><span class="mf">1.</span><span class="n">e</span><span class="mi">-4</span><span class="p">};</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">trajectory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">integrate</span><span class="p">(</span><span class="mf">0.025</span><span class="p">,</span><span class="w"> </span><span class="mf">50.0</span><span class="p">,</span><span class="w"> </span><span class="n">tol</span><span class="p">);</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;# number of RHS evaluations = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">n_rhs</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;# number of rejected steps = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">n_reset</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;# dt range = [&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">dt_min</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">dt_max</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;]&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">trajectory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>The Lorenz system is interesting because it is chaotic—small changes to the initial
conditions will lead to very large differences in the solution.</p>
<div class="admonition-try-it admonition">
<p class="admonition-title">try it…</p>
<p>Try changing the initial conditions by <span class="math notranslate nohighlight">\(1\)</span> part in <span class="math notranslate nohighlight">\(10^6\)</span> and compare plots of
<span class="math notranslate nohighlight">\(x\)</span> vs. <span class="math notranslate nohighlight">\(t\)</span>.</p>
</div>
</section>
<section id="example-using-a-lambda-function">
<h2>Example: using a lambda-function<a class="headerlink" href="#example-using-a-lambda-function" title="Link to this heading"></a></h2>
<p>For a simple system, we can use a lambda-function.  Here we solve:</p>
<div class="math notranslate nohighlight">
\[\frac{dy}{dt} = -y\]</div>
<p>with <span class="math notranslate nohighlight">\(y(0) = 1\)</span>.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="monte-carlo.html" class="btn btn-neutral float-left" title="Monte Carlo Methods" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="poisson-relax.html" class="btn btn-neutral float-right" title="Poisson Equation and Relaxation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022-2024, Michael Zingale.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  


</body>
</html>